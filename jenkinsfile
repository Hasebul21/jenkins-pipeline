pipeline {
    agent any

    tools {
        nodejs 'NODE24'
    }

    parameters {
        choice(
            name: 'DEPLOY_ENV',
            choices: ['staging', 'production'],
            description: 'Select the environment to deploy to'
        )
        string(
            name: 'BRANCH_TO_BUILD',
            defaultValue: 'main',
            description: 'Enter the branch you want to build'
        )
        booleanParam(
            name: 'RUN_BACKEND_TESTS',
            defaultValue: true,
            description: 'Run backend unit tests?'
        )
        booleanParam(
            name: 'RUN_FRONTEND_TESTS',
            defaultValue: true,
            description: 'Run frontend unit tests?'
        )
        booleanParam(
            name: 'PUSH_BACKEND_DOCKER',
            defaultValue: true,
            description: 'Build and push backend Docker image?'
        )
        booleanParam(
            name: 'PUSH_FRONTEND_DOCKER',
            defaultValue: true,
            description: 'Build and push frontend Docker image?'
        )
    }

    environment {
        DOCKERHUB_CREDENTIALS = 'dockerhub'
        DOCKERHUB_USER = 'hasebul21'
        SLACK_CHANNEL = '#recruitment-app-jenkins-alerts'
        TIMEZONE = 'Asia/Dhaka'
    }

    stages {

        stage('Checkout Backend') {
    steps {
        dir('backend') {
            echo "üì• Checking out backend branch: ${params.BRANCH_TO_BUILD}"
            checkout([$class: 'GitSCM', 
                branches: [[name: "*/${params.BRANCH_TO_BUILD}"]],
                userRemoteConfigs: [[
                    url: 'https://github.com/Hasebul21/jenkins-pipeline.git',
                    credentialsId: 'github-pat' // Use the Jenkins PAT credentials
                ]]
            ])
        }
    }
}

stage('Checkout Frontend') {
    steps {
        dir('frontend') {
            echo "üì• Checking out frontend branch: ${params.BRANCH_TO_BUILD}"
            checkout([$class: 'GitSCM', 
                branches: [[name: "*/${params.BRANCH_TO_BUILD}"]],
                userRemoteConfigs: [[
                    url: 'https://github.com/Hasebul21/jenkins-pipeline.git',
                    credentialsId: 'github-pat' // Use the Jenkins PAT credentials
                ]]
            ])
        }
    }
}


        stage('Backend Installation') {
            steps {
                dir('backend') {
                    echo 'üì¶ Installing backend dependencies...'
                    sh 'npm install'
                }
            }
        }

        stage('Backend Build') {
            steps {
                dir('backend') {
                    echo 'üèóÔ∏è Building backend...'
                    sh 'npm run build'
                }
            }
        }

        stage('Backend Test') {
            when { expression { return params.RUN_BACKEND_TESTS } }
            steps {
                dir('backend') {
                    echo 'üß™ Running backend tests...'
                    sh 'npm test'
                }
            }
        }

        stage('Frontend Installation') {
            steps {
                dir('frontend') {
                    echo 'üì¶ Installing frontend dependencies...'
                    sh 'npm install'
                }
            }
        }

        stage('Frontend Build') {
            steps {
                dir('frontend') {
                    echo 'üèóÔ∏è Building frontend...'
                    sh 'npm run build'
                }
            }
        }

        stage('Frontend Test') {
            when { expression { return params.RUN_FRONTEND_TESTS } }
            steps {
                dir('frontend') {
                    echo 'üß™ Running frontend tests...'
                    sh 'npm run test'
                }
            }
        }

        stage('Docker Build and Push Backend') {
            when { expression { return params.PUSH_BACKEND_DOCKER } }
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKERHUB_CREDENTIALS) {
                        dir('backend') {
                            def backendTag = params.DEPLOY_ENV == 'production' ? 'latest' : 'staging'
                            echo "üê≥ Building backend Docker image for ${params.DEPLOY_ENV}"
                            def backendImage = docker.build("${DOCKERHUB_USER}/jenkins_backend-app:${backendTag}")
                            echo "üöÄ Pushing backend Docker image: ${DOCKERHUB_USER}/jenkins_backend-app:${backendTag}"
                            backendImage.push()
                        }
                    }
                }
            }
        }

        stage('Docker Build and Push Frontend') {
            when { expression { return params.PUSH_FRONTEND_DOCKER } }
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKERHUB_CREDENTIALS) {
                        dir('frontend') {
                            def frontendTag = params.DEPLOY_ENV == 'production' ? 'latest' : 'staging'
                            echo "üê≥ Building frontend Docker image for ${params.DEPLOY_ENV}"
                            def frontendImage = docker.build("${DOCKERHUB_USER}/jenkins_frontend-app:${frontendTag}")
                            echo "üöÄ Pushing frontend Docker image: ${DOCKERHUB_USER}/jenkins_frontend-app:${frontendTag}"
                            frontendImage.push()
                        }
                    }
                }
            }
        }

    }

    post {
        success {
            echo '‚úÖ Build succeeded'
        }
        failure {
            echo '‚ùå Build failed'
        }
    }
}
